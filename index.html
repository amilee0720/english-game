<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½è‹±æ–‡å–®å­—æŒ‘æˆ°</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f39c12;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --correct-color: #2ecc71;
            --wrong-color: #e74c3c;
            --text-color: #333;
            --done-bg: #d4edda;
            --done-text: #155724;
            --done-border: #c3e6cb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-x: hidden; user-select: none; color: var(--text-color);
        }

        h1, h2, h3 { color: var(--text-color); margin: 10px 0; }

        .btn {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
            font-size: 16px; transition: 0.2s; margin: 5px; font-weight: bold;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--wrong-color); color: white; }
        .btn-success { background-color: var(--correct-color); color: white; }
        .btn-secondary { background-color: #95a5a6; color: white; font-size: 14px; }
        .btn-outline { background-color: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
        .btn-small { padding: 5px 10px; font-size: 12px; margin: 0 2px;}

        .btn-giant {
            padding: 20px 50px; font-size: 24px; border-radius: 50px;
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white; box-shadow: 0 5px 0 #962d22; margin-top: 10px;
        }
        .btn-giant:active { transform: translateY(5px); box-shadow: none; }

        /* é¦–é  */
        #landingPage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            z-index: 2000; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
        }
        .landing-title {
            font-size: 48px; color: #fff; text-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 30px; animation: bounce 2s infinite; font-weight: 900;
        }
        .enter-btn {
            padding: 15px 60px; font-size: 28px; background: white; color: var(--primary-color);
            border-radius: 50px; border: 4px solid white; font-weight: bold;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: 0.3s; cursor: pointer;
        }
        .enter-btn:hover { transform: scale(1.1); background: var(--secondary-color); color: white; border-color: var(--secondary-color); }
        .floating-icon { position: absolute; font-size: 40px; opacity: 0.8; animation: float 6s ease-in-out infinite; pointer-events: none; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
        @keyframes float { 0% {transform: translateY(0px) rotate(0deg);} 50% {transform: translateY(-30px) rotate(10deg);} 100% {transform: translateY(0px) rotate(0deg);} }

        .admin-trigger-btn {
            position: fixed; top: 15px; left: 15px; z-index: 1500;
            background: rgba(255,255,255,0.8); border: 1px solid #ccc;
            padding: 8px 15px; border-radius: 20px; font-size: 14px;
            cursor: pointer; color: #666; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s; display: none;
        }
        .admin-trigger-btn:hover { background: white; color: var(--primary-color); }

        .container {
            background-color: var(--card-bg); padding: 30px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 800px;
            text-align: center; display: none; position: relative; margin-top: 60px;
        }
        .active-section { display: block; }
        .progress-info { font-size: 14px; color: #555; margin-bottom: 10px; font-weight: bold; }

        .mode-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
            margin-bottom: 15px; background: #e0e0e0; padding: 15px; border-radius: 15px;
            max-width: 800px;
        }
        .mode-btn {
            padding: 10px 20px; border-radius: 25px; border: 2px solid transparent; background: #f8f9fa;
            cursor: pointer; font-weight: bold; color: #555; transition: 0.2s; font-size: 15px;
            position: relative; min-width: 80px;
        }
        .mode-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .mode-btn.active { background-color: white; color: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3); }
        .mode-btn.completed { background-color: var(--done-bg) !important; color: var(--done-text) !important; border-color: var(--done-border) !important; }
        .mode-btn.completed::after { content: 'âœ…'; font-size: 14px; position: absolute; top: -8px; right: -8px; background: white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); padding: 2px; }
        .mode-btn.locked { background-color: #e9ecef; color: #adb5bd; cursor: not-allowed; pointer-events: none; border-color: transparent; }
        .mode-btn.locked::after { content: 'ğŸ”’'; font-size: 12px; position: absolute; top: -5px; right: -5px; }
        .mode-btn.unlocked-game { background-color: var(--secondary-color); color: white; animation: pop 0.5s; border-color: #e67e22; }
        @keyframes pop { 0% { transform: scale(0.8); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .source-settings-card { background: #eef2f5; border: 2px solid #cbd5e0; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; }
        .manage-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .manage-tab { padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; background: #eee; color: #777; border: none; transition: 0.2s; }
        .manage-tab.active { background: var(--primary-color); color: white; }
        .admin-tabs { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .admin-tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 16px; font-weight: bold; color: #888; border-bottom: 3px solid transparent; transition: 0.3s; margin: 0 5px; }
        .admin-tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .admin-content-pane { display: none; animation: fadeIn 0.3s; }
        .admin-content-pane.active { display: block; }
        #wordList, #topicWordList { list-style: none; padding: 0; margin-top: 10px; text-align: left; }
        #wordList li, #topicWordList li { background: #f8f9fa; margin-bottom: 10px; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; border: 1px solid #eee; }
        .topic-grid { display: grid; grid-template-columns: 1fr; gap: 10px; text-align: left; }
        .topic-card { background: white; border: 2px solid #ddd; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .admin-controls { display: flex; justify-content: space-between; align-items: center; background: #eee; padding: 10px; border-radius: 8px; margin-top: 20px; margin-bottom: 20px; }
        .admin-img-preview { width: 60px; height: 60px; border-radius: 5px; object-fit: cover; border: 1px solid #ccc; background: #eee; }
        .admin-word-input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 18px; font-weight: bold; color: #333; }
        .progress-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 10px; border-bottom: 1px solid #eee; text-align: left; }
        .status-tag { font-size: 14px; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .status-done { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-todo { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .radio-group { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; font-weight: bold; color: #444; }
        .radio-group input[type="radio"] { transform: scale(1.2); margin-right: 5px; cursor: pointer; }

        .game-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .score-board { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #333; z-index: 10; }
        .replay-audio-mini { position: absolute; bottom: 10px; right: 10px; z-index: 40; }
        .speed-panel { position: absolute; bottom: 10px; left: 10px; z-index: 40; background: rgba(255, 255, 255, 0.8); padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .speed-btn { width: 25px; height: 25px; border-radius: 50%; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 12px; font-weight: bold; color: #666; display: flex; justify-content: center; align-items: center; transition: 0.2s; padding: 0; }
        .speed-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* --- äº’å‹•éŠæˆ²å€å¡Š --- */
        #fallingGameArea { position: relative; width: 100%; height: 400px; background: linear-gradient(to bottom, #87CEEB, #E0F7FA); border: 4px solid #4a90e2; border-radius: 15px; overflow: hidden; display: none; }
        .falling-item { position: absolute; width: 120px; height: 120px; top: -150px; background-color: white; border-radius: 15px; border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; overflow: hidden; transition: transform 0.2s, background-color 0.2s; }
        .falling-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        
        /* ç¸®å°çš„æ‰“åœ°é¼  */
        #whackGameArea { 
            position: relative; width: 100%; max-width: 500px; margin: 0 auto; /* ä¿®æ­£2ï¼šé™åˆ¶å¯¬åº¦ */
            background: #8d6e63; border-radius: 15px; overflow: hidden; border: 4px solid #5d4037; display: none; padding: 40px 10px 10px 10px; 
        }
        .mole-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .mole-hole { width: 100%; aspect-ratio: 1/1; background: #3e2723; border-radius: 50%; position: relative; overflow: hidden; box-shadow: inset 0 5px 10px rgba(0,0,0,0.5); }
        .mole { width: 80%; height: 80%; position: absolute; left: 10%; bottom: -100%; transition: bottom 0.2s; background: white; border-radius: 50%; border: 3px solid #fff; cursor: pointer; overflow: hidden; }
        .mole.up { bottom: 10%; }
        .mole img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        
        #conveyorGameArea { position: relative; width: 100%; height: 350px; background: #ecf0f1; border-radius: 15px; overflow: hidden; border: 4px solid #bdc3c7; display: none; }
        .conveyor-track { position: absolute; top: 100px; left: 0; width: 100%; height: 120px; background: #95a5a6; border-top: 5px solid #7f8c8d; border-bottom: 5px solid #7f8c8d; }
        .conveyor-zone { position: absolute; top: 90px; left: 50%; transform: translateX(-50%); width: 140px; height: 140px; border: 5px dashed #e74c3c; border-radius: 10px; z-index: 5; pointer-events: none; background: rgba(231, 76, 60, 0.1); }
        .conveyor-item { position: absolute; top: 110px; width: 100px; height: 100px; background: white; border: 2px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; overflow: hidden; box-shadow: 0 4px 5px rgba(0,0,0,0.2); z-index: 2; }
        .conveyor-item img { width: 90%; height: 90%; object-fit: contain; pointer-events: none; }

        #matchGameArea { position: relative; width: 100%; min-height: 500px; background: #fff8e1; border: 4px solid #f39c12; border-radius: 15px; display: none; flex-direction: column; overflow: hidden; }
        .match-row { display: flex; justify-content: space-around; align-items: center; height: 140px; padding: 10px; background: rgba(255,255,255,0.5); }
        .match-center-zone { flex: 1; position: relative; border-top: 2px dashed #ccc; border-bottom: 2px dashed #ccc; background: rgba(0,0,0,0.02); min-height: 180px; }
        .match-target { width: 110px; height: 110px; border: 3px solid #ccc; border-radius: 10px; background: white; display: flex; justify-content: center; align-items: center; overflow: visible; transition: 0.3s; position: relative; }
        .match-target img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; pointer-events: none; }
        .match-target.hover-play { border-color: var(--secondary-color); box-shadow: 0 0 10px var(--secondary-color); transform: scale(1.05); }
        .match-target.matched { border-color: var(--correct-color); box-shadow: 0 0 10px var(--correct-color); opacity: 1; }
        .match-target.matched::after { content: 'âœ”'; font-size: 30px; color: var(--correct-color); position: absolute; top: -10px; right: -10px; background: white; border-radius: 50%; width: 30px; height: 30px; text-align: center; line-height: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 25; }
        .match-card { position: absolute; padding: 15px 20px; background: white; border: 3px solid #555; border-radius: 10px; font-weight: bold; font-size: 24px; cursor: grab; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s; user-select: none; z-index: 10; }
        .match-card:active { cursor: grabbing; transform: scale(1.1) !important; z-index: 20; }
        .match-card.selected { background-color: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); z-index: 30; transform: scale(1.2) !important; }
        .match-card.docked-card { position: absolute; bottom: 0px; left: 50%; transform: translate(-50%, 50%); z-index: 20; background: #f1c40f; border: 3px solid #d35400; color: #2c3e50; box-shadow: 0 4px 10px rgba(0,0,0,0.4); padding: 5px 15px; font-size: 20px; pointer-events: none; white-space: nowrap; cursor: default; font-weight: 900; }

        /* éœæ…‹é¡Œå‹ */
        #staticGameArea { display: block; }
        /* ä¿®æ­£1ï¼šä¸»åœ–ç‰‡å®¹å™¨æ”¾å¤§ */
        .image-container { position: relative; width: 100%; height: 450px; background-color: #eee; border-radius: 10px; margin-bottom: 10px; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .game-image { width: 100%; height: 100%; object-fit: contain; background-color: #fff; transition: opacity 0.3s; }
        .blurred-image { filter: blur(20px); opacity: 0.5; }
        .word-puzzle { font-size: 32px; font-weight: bold; letter-spacing: 5px; margin: 20px 0; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .letter-box { display: inline-block; width: 40px; text-align: center; }
        .missing-letter-input { width: 40px; height: 45px; font-size: 24px; text-align: center; border: 2px solid #ccc; border-radius: 5px; text-transform: lowercase; outline: none; }
        .missing-letter-input.correct { background-color: #e8f8f5; color: #2ecc71; font-weight: bold; border-color: #2ecc71; }
        .scramble-hint { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .scramble-tile { background: #f0f0f0; padding: 8px 15px; border-radius: 5px; border: 1px solid #ddd; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .image-option, .text-option { border: 4px solid #ddd; border-radius: 10px; cursor: pointer; overflow: hidden; background: #eee; transition: 0.2s; display: flex; justify-content: center; align-items: center; }
        .text-option { background: white; padding: 15px; font-size: 20px; font-weight: bold; min-height: 50px; }
        
        /* ä¿®æ­£1ï¼šé¸é …åœ–ç‰‡æ”¾å¤§ */
        .image-option { height: 200px; background: #fff; }
        .image-option img { width: 100%; height: 100%; object-fit: contain; }
        .correct-answer { border-color: #2ecc71 !important; background-color: #e8f8f5 !important; }
        .wrong-answer { border-color: #e74c3c !important; opacity: 0.6; }

        .toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 3000; }
        .loading-spinner { position: absolute; color: #888; }
        .input-group { display: flex; gap: 10px; }
        .input-group input { flex: 1; padding: 10px; }

        /* ä¿®æ­£3ï¼šéº¥å…‹é¢¨å„ªåŒ– */
        .mic-btn {
            width: 140px; height: 140px; border-radius: 50%; border: none;
            background-color: #3498db; color: white; font-size: 70px;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: 0.3s; display: flex; justify-content: center; align-items: center;
            margin: 20px auto;
        }
        .mic-btn:hover { background-color: #2980b9; transform: scale(1.05); }
        .mic-btn.listening {
            background-color: #e74c3c !important; /* ç´…è‰² */
            box-shadow: 0 0 20px #c0392b; /* ç´…è‰²å…‰æšˆ */
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        
        .speaking-result { font-size: 20px; font-weight: bold; min-height: 30px; margin-top: 10px; color: #555; }

        /* å‹•ç•« */
        .falling-item.shake-hard, .mole.hit-wrong { animation: shakeHard 0.5s ease-in-out; background-color: #e74c3c !important; border-color: #e74c3c !important; }
        .mole.hit-correct, .falling-item.processed[style*="background: rgb(46, 204, 113)"] { transform: scale(1.2); transition: 0.2s; }
        @keyframes shakeHard { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-10px); } 40%, 80% { transform: translateX(10px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <!-- é¦–é  (Landing Page) -->
    <div id="landingPage">
        <span class="floating-icon" style="top:10%; left:10%; animation-delay:0s;">â­</span>
        <span class="floating-icon" style="top:20%; right:15%; animation-delay:1s;">ğŸ“</span>
        <span class="floating-icon" style="bottom:15%; left:20%; animation-delay:2s;">ğŸ¶</span>
        <span class="floating-icon" style="bottom:25%; right:10%; animation-delay:3s;">ğŸ</span>
        <span class="floating-icon" style="top:50%; left:5%; animation-delay:4s; font-size:30px;">A</span>
        <span class="floating-icon" style="top:50%; right:5%; animation-delay:1.5s; font-size:30px;">B</span>
        
        <div class="landing-title">å…¨æ–¹ä½<br>è‹±æ–‡å–®å­—æŒ‘æˆ°</div>
        <button class="enter-btn" onclick="enterGame()">é€²å…¥æŒ‘æˆ° â</button>
    </div>

    <!-- å·¦ä¸Šè§’å¾Œå°è§¸ç™¼æŒ‰éˆ• -->
    <button id="adminTriggerBtn" class="admin-trigger-btn" onclick="checkAdminPassword()">âš™ï¸ è¨­å®š</button>

    <!-- å¾Œå°è¨­å®šå€å¡Š -->
    <div id="adminSection" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>å¾Œå°è¨­å®š</h2>
            <button class="btn btn-secondary btn-small" onclick="switchView('game')">è¿”å›å‰å°</button>
        </div>
        
        <div class="admin-tabs">
            <button class="admin-tab-btn active" id="tabBtn_vocab" onclick="switchAdminTab('vocab')">ğŸ“– å–®å­—ç®¡ç†</button>
            <button class="admin-tab-btn" id="tabBtn_progress" onclick="switchAdminTab('progress')">ğŸ† é€²åº¦ç®¡ç†</button>
        </div>

        <div id="adminTab_vocab" class="admin-content-pane active">
            <!-- ä¾†æºè¨­å®šå€ -->
            <div class="source-settings-card">
                <h3 style="margin-top:0;">ğŸ® é¡Œç›®å¥—ç”¨è¨­å®š (Source)</h3>
                <p style="font-size:13px; color:#666; margin-bottom:10px;">è«‹é¸æ“‡å‰å°éŠæˆ²è¦ä½¿ç”¨å“ªä¸€ä»½é¡Œåº«ï¼š</p>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="gameSource" value="list" onchange="updateGameSettings()"> å–®å­—åˆ—è¡¨
                    </label>
                </div>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="gameSource" value="topic" onchange="updateGameSettings()"> ä¸»é¡Œå°ˆå€
                    </label>
                    <select id="activeTopicSelect" class="topic-select" disabled onchange="updateGameSettings()">
                        <option value="">-- è«‹é¸æ“‡ä¸»é¡Œ --</option>
                    </select>
                </div>
            </div>

            <!-- å…§å®¹ç®¡ç†å€ -->
            <div class="manage-tabs">
                <button class="manage-tab active" id="manageBtn_list" onclick="switchManageView('list')">ç®¡ç†å–®å­—åˆ—è¡¨</button>
                <button class="manage-tab" id="manageBtn_topic" onclick="switchManageView('topic')">ç®¡ç†ä¸»é¡Œå°ˆå€</button>
            </div>

            <!-- å–®å­—åˆ—è¡¨ç·¨è¼¯å™¨ -->
            <div id="managePane_list" style="display:block;">
                <div class="input-group">
                    <input type="text" id="newWordInput" placeholder="è¼¸å…¥å–®å­— (ä¾‹å¦‚: cat, pencil)" onkeypress="handleEnter(event, 'list')">
                    <button class="btn btn-primary" onclick="addWord('list')">æ–°å¢</button>
                </div>
                <div class="admin-controls" id="adminControls_list" style="display:none;">
                    <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" id="selectAllBox_list" onchange="toggleSelectAll(this.checked, 'list')"> å…¨é¸
                    </label>
                    <button class="btn btn-danger btn-small" onclick="deleteSelectedWords('list')">åˆªé™¤é¸å–é …</button>
                </div>
                <ul id="wordList"></ul>
            </div>

            <!-- ä¸»é¡Œå°ˆå€ç·¨è¼¯å™¨ -->
            <div id="managePane_topic" style="display:none;">
                <!-- ä¸»é¡Œåˆ—è¡¨ -->
                <div id="topicListSection">
                    <div class="input-group">
                        <input type="text" id="newTopicInput" placeholder="è¼¸å…¥æ–°ä¸»é¡Œåç¨± (ä¾‹å¦‚: æ˜ŸæœŸ, å‹•ç‰©)" onkeypress="handleEnterTopic(event)">
                        <button class="btn btn-primary" onclick="addTopic()">æ–°å¢ä¸»é¡Œ</button>
                    </div>
                    <p style="font-size:13px; color:#666; margin:10px 0;">é»æ“Šä¸»é¡Œå¡ç‰‡é€²å…¥ç·¨è¼¯å–®å­—ï¼š</p>
                    <div id="topicGrid" class="topic-grid"></div>
                </div>

                <!-- å–®ä¸€ä¸»é¡Œå…§éƒ¨çš„å–®å­—åˆ—è¡¨ -->
                <div id="topicDetailSection" style="display:none;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                        <button class="btn btn-secondary" onclick="exitTopicDetail()">â¬… è¿”å›ä¸»é¡Œ</button>
                        <h3 id="currentTopicNameTitle" style="margin:0;">ä¸»é¡Œåç¨±</h3>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" id="newTopicWordInput" placeholder="åœ¨æ­¤ä¸»é¡Œæ–°å¢å–®å­—" onkeypress="handleEnter(event, 'topic')">
                        <button class="btn btn-primary" onclick="addWord('topic')">æ–°å¢</button>
                    </div>
                    
                    <div class="admin-controls" id="adminControls_topic" style="display:none;">
                        <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                            <input type="checkbox" id="selectAllBox_topic" onchange="toggleSelectAll(this.checked, 'topic')"> å…¨é¸
                        </label>
                        <button class="btn btn-danger btn-small" onclick="deleteSelectedWords('topic')">åˆªé™¤é¸å–é …</button>
                    </div>
                    <ul id="topicWordList"></ul>
                </div>
            </div>
        </div>

        <div id="adminTab_progress" class="admin-content-pane">
            <p style="font-size:14px; color:#666; margin-bottom:15px;">ç¢ºèªå„é—œå¡å®Œæˆç‹€æ…‹ï¼š</p>
            <div id="adminProgressList"></div>
            <div style="margin-top:20px; text-align:center; border-top:1px dashed #ccc; padding-top:15px;">
                <button class="btn btn-danger" onclick="resetProgress()">âš ï¸ å…¨éƒ¨é€²åº¦æ­¸é›¶ (æ¸¬è©¦ç”¨)</button>
            </div>
        </div>
    </div>

    <!-- éŠæˆ²å‰å°å€å¡Š -->
    <div id="gameSection" class="container">
        
        <div class="mode-container">
            <!-- åŸºç¤é¡Œå‹ -->
            <button class="mode-btn" id="modeBtn_reading" onclick="setGameMode('reading')">çœ‹åœ–é¸å­—</button>
            <button class="mode-btn" id="modeBtn_listening" onclick="setGameMode('listening')">è½éŸ³é¸å­—</button>
            <button class="mode-btn" id="modeBtn_spelling" onclick="setGameMode('spelling')">å–®å­—å¡«ç©º</button>
            <button class="mode-btn" id="modeBtn_unscramble" onclick="setGameMode('unscramble')">å–®å­—é‡çµ„</button>
            <button class="mode-btn" id="modeBtn_dictation" onclick="setGameMode('dictation')">è½å¯«æ¸¬é©—</button>
            <button class="mode-btn" id="modeBtn_speaking" onclick="setGameMode('speaking')">å£èªªç·´ç¿’</button>
            
            <div style="width: 100%; height: 1px; background: #ccc; margin: 5px 0;"></div>
            <p style="width:100%; font-size:16px; color:#666; margin:0; text-align:center;">å®Œæˆä¸Šæ–¹æ‰€æœ‰é¡Œå‹å¾Œï¼Œå³å¯è§£é–ä¸‹æ–¹éŠæˆ²</p>
            
            <button class="mode-btn locked" id="modeBtn_falling" onclick="setGameMode('falling')">ğŸŒ  æµæ˜Ÿé›¨</button>
            <button class="mode-btn locked" id="modeBtn_whack" onclick="setGameMode('whack')">ğŸ”¨ æ‰“åœ°é¼ </button>
            <button class="mode-btn locked" id="modeBtn_conveyor" onclick="setGameMode('conveyor')">ğŸ­ è¼¸é€å¸¶</button>
            <button class="mode-btn locked" id="modeBtn_match" onclick="setGameMode('match')">ğŸ§© åœ–ç‰‡é…å°</button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="gameTitle">æ‹¼å­—ç·´ç¿’</h2>
            <div id="progressDisplay" class="progress-info"></div>
        </div>

        <div id="stageClearMsg" style="display:none; text-align:center; padding:20px; background:#e8f8f5; border-radius:10px; margin-bottom:20px; border:2px solid #2ecc71;">
            <h2 style="color:#2ecc71;">ğŸ‰ é—œå¡å®Œæˆï¼</h2>
            <p>å¤ªæ£’äº†ï¼é€™å€‹é¡Œå‹å·²ç¶“å…¨éƒ¨ç·´ç¿’å®Œç•¢ã€‚</p>
            <button class="btn btn-primary" onclick="continueToNextMode()">å‰å¾€ä¸‹ä¸€é—œ</button>
            <button class="btn btn-outline" onclick="switchView('game')">å›ä¸»é¸å–®</button>
        </div>

        <div id="gameContent">
            <!-- äº’å‹•éŠæˆ²å€ -->
            <div id="fallingGameArea"><div class="score-board"><span>Score: <span id="fallingScore">0</span></span><span style="color:#e74c3c" id="fallingHearts">â¤ï¸â¤ï¸â¤ï¸</span></div><div id="fallingOverlay" class="game-overlay"><h3>æº–å‚™å¥½äº†å—ï¼Ÿ</h3><button class="btn btn-primary" onclick="startMinigame('falling')">é–‹å§‹éŠæˆ²</button></div>
                <div class="speed-panel"><span class="speed-label">é€Ÿåº¦:</span><button class="speed-btn active" onclick="setSpeedLevel('falling', 1, this)">1</button><button class="speed-btn" onclick="setSpeedLevel('falling', 2, this)">2</button><button class="speed-btn" onclick="setSpeedLevel('falling', 3, this)">3</button><button class="speed-btn" onclick="setSpeedLevel('falling', 4, this)">4</button><button class="speed-btn" onclick="setSpeedLevel('falling', 5, this)">5</button></div>
                <button class="btn btn-secondary replay-audio-mini" onclick="playCurrentAudio()">ğŸ”Š é‡è½</button><div id="fallingItemsContainer"></div></div>
            <div id="whackGameArea"><div class="score-board" style="color:#fff;"><span>Score: <span id="whackScore">0</span></span><span style="color:#e74c3c" id="whackHearts">â¤ï¸â¤ï¸â¤ï¸</span></div><div id="whackOverlay" class="game-overlay"><h3>æº–å‚™å¥½äº†å—ï¼Ÿ</h3><button class="btn btn-primary" onclick="startMinigame('whack')">é–‹å§‹éŠæˆ²</button></div><button class="btn btn-secondary replay-audio-mini" onclick="playCurrentAudio()">ğŸ”Š é‡è½</button><div class="mole-grid" id="moleGrid"><div class="mole-hole"><div class="mole"></div></div><div class="mole-hole"><div class="mole"></div></div><div class="mole-hole"><div class="mole"></div></div><div class="mole-hole"><div class="mole"></div></div><div class="mole-hole"><div class="mole"></div></div><div class="mole-hole"><div class="mole"></div></div><div class="mole-hole"><div class="mole"></div></div><div class="mole-hole"><div class="mole"></div></div><div class="mole-hole"><div class="mole"></div></div></div></div>
            <div id="conveyorGameArea"><div class="score-board"><span>Score: <span id="conveyorScore">0</span></span><span style="color:#e74c3c" id="conveyorHearts">â¤ï¸â¤ï¸â¤ï¸</span></div><div id="conveyorOverlay" class="game-overlay"><h3>æº–å‚™å¥½äº†å—ï¼Ÿ</h3><button class="btn btn-primary" onclick="startMinigame('conveyor')">é–‹å§‹éŠæˆ²</button></div>
                <div class="speed-panel"><span class="speed-label">é€Ÿåº¦:</span><button class="speed-btn active" onclick="setSpeedLevel('conveyor', 1, this)">1</button><button class="speed-btn" onclick="setSpeedLevel('conveyor', 2, this)">2</button><button class="speed-btn" onclick="setSpeedLevel('conveyor', 3, this)">3</button><button class="speed-btn" onclick="setSpeedLevel('conveyor', 4, this)">4</button><button class="speed-btn" onclick="setSpeedLevel('conveyor', 5, this)">5</button></div>
                <div class="conveyor-track"></div><div class="conveyor-zone"></div><div id="conveyorItems"></div><div style="position:absolute; bottom:20px; width:100%; text-align:center;"><button class="btn btn-secondary" style="margin-right:20px;" onclick="playCurrentAudio()">ğŸ”Š é‡è½</button><button class="btn btn-giant" id="conveyorGrabBtn">âœ‹ æŠ“å–!</button></div></div>
            
            <!-- æ–°å¢ï¼šé…å°éŠæˆ²å€ -->
            <div id="matchGameArea">
                <div class="score-board"><span>Score: <span id="matchScore">0</span></span><span style="color:#e74c3c" id="matchHearts">â¤ï¸â¤ï¸â¤ï¸</span></div>
                <div id="matchOverlay" class="game-overlay"><h3>é…å°æŒ‘æˆ°</h3><p>æ‹–æ›³å–®å­—å¡åˆ°æ­£ç¢ºåœ–ç‰‡ä¸Š</p><button class="btn btn-primary" onclick="startMinigame('match')">é–‹å§‹éŠæˆ²</button></div>
                
                <!-- ä¸Šæ–¹åœ–ç‰‡å€ -->
                <div class="match-row" id="matchTopRow"></div>
                
                <!-- ä¸­é–“å–®å­—å¡æ•£è½å€ -->
                <div class="match-center-zone" id="matchCenterZone"></div>
                
                <!-- ä¸‹æ–¹åœ–ç‰‡å€ -->
                <div class="match-row" id="matchBottomRow"></div>
            </div>

            <!-- éœæ…‹éŠæˆ²å€ -->
            <div id="staticGameArea">
                <div id="commonImageArea"><div class="image-container"><div id="loadingText" class="loading-spinner">...</div><img id="questionImage" class="game-image" src="" alt="" style="opacity: 0;"></div></div>
                <div id="commonAudioBtn" style="display:none;"><button class="btn audio-btn" style="background:#f39c12; color:white; border-radius:30px;" onclick="playCurrentAudio()">ğŸ”Š æ’­æ”¾ç™¼éŸ³</button></div>
                <div id="inputTypeArea" style="display: block;"><div id="scrambleHint" class="scramble-hint" style="display:none;"></div><div id="wordPuzzle" class="word-puzzle"></div><button id="submitBtn" class="btn btn-primary" onclick="checkInputAnswer()">é€å‡ºç­”æ¡ˆ</button></div>
                <div id="choiceTypeArea" style="display: none;"><div class="options-grid" id="optionsGrid"></div></div>
                
                <div id="speakingArea" style="display: none; text-align: center;">
                    <p style="margin-bottom:10px; color:#666;">è«‹é»æ“Šéº¥å…‹é¢¨ï¼Œä¸¦å¤§è²å”¸å‡ºå–®å­—ï¼</p>
                    <button id="micBtn" class="mic-btn" onclick="startListening()">ğŸ¤</button>
                    <div id="speakingResult" class="speaking-result"></div>
                </div>

                <div id="feedbackMsg" class="feedback"></div>
                <button id="nextBtn" class="btn btn-success" onclick="nextQuestion()" style="display: none;">ä¸‹ä¸€é¡Œ â</button>
            </div>
        </div>
        <div id="emptyState" style="display: none;"><p>ç›®å‰é¡Œåº«ç‚ºç©ºï¼Œè«‹è‡³å¾Œå°æª¢æŸ¥è¨­å®šï¼<br>(è«‹ç¢ºèªå·²é¸æ“‡ã€Œä¸»é¡Œã€ä¸”è©²ä¸»é¡Œå…§æœ‰å–®å­—)</p></div>
    </div>
    
    <div id="roundToast" class="toast"></div>

    <script>
        // --- è³‡æ–™ç®¡ç† ---
        let defaultWords = JSON.parse(localStorage.getItem('vocabWords'));
        if (!defaultWords) defaultWords = [{ text: 'cat', suffix: '' }, { text: 'dog', suffix: '' }];
        if (defaultWords.length > 0 && typeof defaultWords[0] === 'string') defaultWords = defaultWords.map(w => ({ text: w, suffix: '' }));

        let topicData = JSON.parse(localStorage.getItem('topicData')) || []; 
        let gameSettings = JSON.parse(localStorage.getItem('gameSettings')) || { source: 'list', activeTopicId: null };
        let activeWords = []; 
        let editingTopicId = null;
        let progress = JSON.parse(localStorage.getItem('gameProgress')) || {
            reading: false, listening: false, spelling: false, unscramble: false, dictation: false, speaking: false
        };

        const modeNames = { reading: 'çœ‹åœ–é¸å­—', listening: 'è½éŸ³é¸å­—', spelling: 'å–®å­—å¡«ç©º', unscramble: 'å–®å­—é‡çµ„', dictation: 'è½å¯«æ¸¬é©—', speaking: 'å£èªªç·´ç¿’' };
        const basicModeOrder = ['reading', 'listening', 'spelling', 'unscramble', 'dictation', 'speaking'];

        let gameQueue = []; let currentWord = null; let currentMode = 'reading'; 
        let currentQuestionVoice = null; let voices = []; let canClickChoice = true;
        let imageRequestId = 0;

        let miniGameInterval = null; let miniGameLoop = null; 
        let lives = 3; let score = 0; let isGameRunning = false;
        let activeItems = []; let itemsSinceLastTarget = 0;
        let fallingSpeedLevel = 1; let conveyorSpeedLevel = 1;
        
        let matchSelectedWord = null; 

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        window.speechSynthesis.onvoiceschanged = () => { voices = window.speechSynthesis.getVoices(); };

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if(recognition) {
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = (event) => {
                const micBtn = document.getElementById('micBtn');
                micBtn.classList.remove('listening');
                const transcript = event.results[0][0].transcript.toLowerCase();
                const target = currentWord.text.toLowerCase();
                const cleanTranscript = transcript.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
                const cleanTarget = target.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
                document.getElementById('speakingResult').textContent = `è½åˆ°: "${transcript}"`;
                
                if(cleanTranscript === cleanTarget) {
                    document.getElementById('speakingResult').style.color = '#2ecc71';
                    playSFX('correct');
                    showFeedback(true, currentWord.text);
                } else {
                    document.getElementById('speakingResult').style.color = '#e74c3c';
                    playSFX('wrong');
                    showFeedback(false, currentWord.text);
                }
            };
            recognition.onerror = (event) => {
                document.getElementById('micBtn').classList.remove('listening');
                document.getElementById('speakingResult').textContent = "è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦ (æª¢æŸ¥éº¥å…‹é¢¨)";
            };
            recognition.onend = () => {
                document.getElementById('micBtn').classList.remove('listening');
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            initAdminUI();
            renderProgressAdmin(); 
            setTimeout(() => { voices = window.speechSynthesis.getVoices(); }, 100);
        });

        function enterGame() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('adminTriggerBtn').style.display = 'block';
            document.getElementById('gameSection').style.display = 'block'; 
            
            updateActiveWords();
            
            // æ¯æ¬¡é€²å…¥æ™‚ï¼Œè‡ªå‹•æ‰¾ä¸€å€‹é‚„æ²’å®Œæˆçš„åŸºç¤é—œå¡ï¼Œä½†å…è¨±åˆ‡æ›
            const firstIncomplete = basicModeOrder.find(m => !progress[m]);
            if(firstIncomplete) {
                setGameMode(firstIncomplete);
            } else {
                // å¦‚æœå…¨å®Œæˆäº†ï¼Œé è¨­é‚„æ˜¯å…ˆåœåœ¨ç¬¬ä¸€å€‹ï¼Œè®“ä½¿ç”¨è€…è‡ªå·±é¸è¦ç©å“ªå€‹
                setGameMode('reading'); 
            }
            updateModeButtons();
        }

        function checkAdminPassword() {
            const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼(æç¤ºï¼š4å€‹0)ï¼š");
            if (pwd === "0000") {
                switchView('admin');
            } else if (pwd !== null) {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        }

        function updateActiveWords() {
            if (gameSettings.source === 'list') {
                activeWords = [...defaultWords];
            } else if (gameSettings.source === 'topic') {
                const topic = topicData.find(t => t.id == gameSettings.activeTopicId);
                if (topic) {
                    activeWords = [...topic.words];
                } else {
                    activeWords = [];
                }
            }
            checkEmptyState();
        }

        function initAdminUI() {
            document.querySelector(`input[name="gameSource"][value="${gameSettings.source}"]`).checked = true;
            renderTopicSelect();
            toggleTopicSelect(gameSettings.source === 'topic');
            renderWordList('list');
            renderTopicList();
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.admin-content-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(`tabBtn_${tab}`).classList.add('active');
            document.getElementById(`adminTab_${tab}`).classList.add('active');
        }

        function switchManageView(view) {
            document.querySelectorAll('.manage-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(`manageBtn_${view}`).classList.add('active');
            document.getElementById('managePane_list').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('managePane_topic').style.display = view === 'topic' ? 'block' : 'none';
            if(view === 'topic') exitTopicDetail();
        }

        function updateGameSettings() {
            const source = document.querySelector('input[name="gameSource"]:checked').value;
            const topicSelect = document.getElementById('activeTopicSelect');
            gameSettings.source = source;
            if (source === 'topic') {
                gameSettings.activeTopicId = topicSelect.value;
            }
            localStorage.setItem('gameSettings', JSON.stringify(gameSettings));
            toggleTopicSelect(source === 'topic');
            updateActiveWords();
            showToast("è¨­å®šå·²å„²å­˜");
        }

        function toggleTopicSelect(enable) {
            const sel = document.getElementById('activeTopicSelect');
            sel.disabled = !enable;
            if(!enable) {
                sel.value = "";
            } else {
                sel.value = gameSettings.activeTopicId || "";
            }
        }

        function renderTopicSelect() {
            const sel = document.getElementById('activeTopicSelect');
            sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ä¸»é¡Œ --</option>';
            topicData.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = `${t.name} (${t.words.length}å­—)`;
                sel.appendChild(opt);
            });
            if (gameSettings.activeTopicId) sel.value = gameSettings.activeTopicId;
        }

        function renderWordList(mode) {
            const isTopicMode = mode === 'topic';
            const container = isTopicMode ? document.getElementById('topicWordList') : document.getElementById('wordList');
            const data = isTopicMode ? (topicData.find(t=>t.id==editingTopicId)?.words || []) : defaultWords;
            const controls = document.getElementById(isTopicMode ? 'adminControls_topic' : 'adminControls_list');
            
            container.innerHTML = '';
            if(data.length > 0) controls.style.display = 'flex'; else controls.style.display = 'none';

            data.forEach((wObj, i) => {
                const li = document.createElement('li');
                const imgSrc = getBingImg(wObj) + `&t=${new Date().getTime()}`;
                li.innerHTML = `
                    <input type="checkbox" class="admin-checkbox-${mode}" data-index="${i}">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <img src="${imgSrc}" class="admin-img-preview">
                        <button class="btn btn-secondary btn-small" onclick="refreshImage('${mode}', ${i})">ğŸ”„</button>
                    </div>
                    <input class="admin-word-input" type="text" value="${wObj.text}" onchange="updateWord('${mode}', ${i}, this.value)">
                    <button class="btn btn-danger btn-small" onclick="delWord('${mode}', ${i})">åˆªé™¤</button>
                `;
                container.appendChild(li);
            });

            if(!isTopicMode) localStorage.setItem('vocabWords', JSON.stringify(defaultWords));
            else saveTopicData();
        }

        function renderTopicList() {
            const grid = document.getElementById('topicGrid');
            grid.innerHTML = '';
            topicData.forEach(t => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.innerHTML = `
                    <div>
                        <div class="topic-name">${t.name}</div>
                        <div class="topic-count">${t.words.length} å–®å­—</div>
                    </div>
                    <div>
                        <button class="btn btn-primary btn-small" onclick="enterTopicDetail('${t.id}')">ç·¨è¼¯</button>
                        <button class="btn btn-danger btn-small" onclick="deleteTopic('${t.id}')">åˆªé™¤</button>
                    </div>
                `;
                grid.appendChild(card);
            });
            renderTopicSelect(); 
        }

        function addTopic() {
            const input = document.getElementById('newTopicInput');
            const name = input.value.trim();
            if(!name) return;
            const newTopic = { id: Date.now().toString(), name: name, words: [] };
            topicData.push(newTopic);
            saveTopicData();
            input.value = '';
            renderTopicList();
        }

        function deleteTopic(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ä¸»é¡Œå—ï¼Ÿè£¡é¢çš„å–®å­—ä¹Ÿæœƒæ¶ˆå¤±ã€‚")) return;
            topicData = topicData.filter(t => t.id !== id);
            if(gameSettings.activeTopicId == id) {
                gameSettings.activeTopicId = null;
                localStorage.setItem('gameSettings', JSON.stringify(gameSettings));
                updateActiveWords();
            }
            saveTopicData();
            renderTopicList();
        }

        function enterTopicDetail(id) {
            editingTopicId = id;
            const topic = topicData.find(t => t.id == id);
            if(!topic) return;
            document.getElementById('topicListSection').style.display = 'none';
            document.getElementById('topicDetailSection').style.display = 'block';
            document.getElementById('currentTopicNameTitle').textContent = `æ­£åœ¨ç·¨è¼¯ï¼š${topic.name}`;
            renderWordList('topic');
        }

        function exitTopicDetail() {
            editingTopicId = null;
            document.getElementById('topicListSection').style.display = 'block';
            document.getElementById('topicDetailSection').style.display = 'none';
            renderTopicList(); 
        }

        function handleEnterTopic(e) { if(e.key === 'Enter') addTopic(); }
        function saveTopicData() { localStorage.setItem('topicData', JSON.stringify(topicData)); }

        function addWord(mode) {
            const inputId = mode === 'topic' ? 'newTopicWordInput' : 'newWordInput';
            const input = document.getElementById(inputId);
            const v = input.value.trim().toLowerCase();
            if(!/^[a-z]+$/.test(v)) return alert('é™è‹±æ–‡å­—æ¯');
            const list = mode === 'topic' ? topicData.find(t=>t.id==editingTopicId).words : defaultWords;
            if(list.some(w => w.text === v)) return alert('å–®å­—å·²å­˜åœ¨ï¼');
            list.push({ text: v, suffix: '' });
            input.value = '';
            renderWordList(mode);
            if(mode==='list') updateActiveWords();
            else if(mode==='topic' && gameSettings.activeTopicId == editingTopicId) updateActiveWords();
        }

        function updateWord(mode, i, v) {
            const val = v.trim().toLowerCase();
            const list = mode === 'topic' ? topicData.find(t=>t.id==editingTopicId).words : defaultWords;
            if(!/^[a-z]+$/.test(val)) { alert('é™è‹±æ–‡å­—æ¯'); renderWordList(mode); return; }
            if(list.some((w, idx) => idx!==i && w.text===val)) { alert('å–®å­—å·²å­˜åœ¨ï¼'); renderWordList(mode); return; }
            list[i].text = val;
            renderWordList(mode);
        }

        function delWord(mode, i) {
            const list = mode === 'topic' ? topicData.find(t=>t.id==editingTopicId).words : defaultWords;
            list.splice(i, 1);
            renderWordList(mode);
            if(mode==='list') updateActiveWords();
            else if(mode==='topic' && gameSettings.activeTopicId == editingTopicId) updateActiveWords();
        }

        function toggleSelectAll(checked, mode) {
            document.querySelectorAll(`.admin-checkbox-${mode}`).forEach(cb => cb.checked = checked);
        }

        function deleteSelectedWords(mode) {
            const cbs = document.querySelectorAll(`.admin-checkbox-${mode}:checked`);
            if(cbs.length===0) return alert("è«‹é¸å–");
            const idxs = Array.from(cbs).map(c=>parseInt(c.dataset.index));
            if(mode === 'topic') {
                const topic = topicData.find(t=>t.id==editingTopicId);
                topic.words = topic.words.filter((_,i)=>!idxs.includes(i));
                saveTopicData();
            } else {
                defaultWords = defaultWords.filter((_,i)=>!idxs.includes(i));
                localStorage.setItem('vocabWords', JSON.stringify(defaultWords));
            }
            document.getElementById(`selectAllBox_${mode}`).checked = false;
            renderWordList(mode);
            updateActiveWords();
        }

        function refreshImage(mode, index) {
            const list = mode === 'topic' ? topicData.find(t=>t.id==editingTopicId).words : defaultWords;
            const variations = ['', ' cartoon', ' illustration', ' sketch', ' real photo', ' vector', ' clip art', ' 3d icon', ' drawing'];
            let newSuffix = list[index].suffix;
            while (newSuffix === list[index].suffix) newSuffix = variations[Math.floor(Math.random() * variations.length)];
            list[index].suffix = newSuffix;
            renderWordList(mode);
        }

        function handleEnter(e, mode) { if(e.key === 'Enter') addWord(mode); }

        function getBingImg(entry) { const query = entry.text + (entry.suffix || ''); return `https://tse1.mm.bing.net/th?q=${encodeURIComponent(query)}&w=500&h=500&c=7`; }
        
        function setSpeedLevel(mode, level, btn) {
            if(mode === 'falling') fallingSpeedLevel = level;
            else if(mode === 'conveyor') conveyorSpeedLevel = level;
            const container = btn.parentElement;
            container.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- é€²åº¦ç®¡ç† ---
        function renderProgressAdmin() {
            const container = document.getElementById('adminProgressList'); container.innerHTML = '';
            basicModeOrder.forEach(key => {
                const isDone = progress[key];
                const row = document.createElement('div'); row.className = 'progress-row';
                row.innerHTML = `
                    <span>${modeNames[key]}</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="status-tag ${isDone ? 'status-done' : 'status-todo'}">${isDone ? 'âœ… å·²é€šé—œ' : 'â¬œ æœªå®Œæˆ'}</span>
                        <button class="btn btn-success btn-small" onclick="completeSingleProgress('${key}')">ğŸ‰ ä¸€éµé€šé—œ</button>
                        <button class="btn btn-outline btn-small" onclick="resetSingleProgress('${key}')">é‡ç½®</button>
                    </div>`;
                container.appendChild(row);
            });
        }
        
        function resetSingleProgress(mode) { 
            progress[mode] = false; 
            localStorage.setItem('gameProgress', JSON.stringify(progress)); 
            renderProgressAdmin(); updateModeButtons(); 
            showToast(`ã€Œ${modeNames[mode]}ã€é€²åº¦å·²é‡ç½®ï¼`); 
        }

        function completeSingleProgress(mode) {
            progress[mode] = true;
            localStorage.setItem('gameProgress', JSON.stringify(progress));
            renderProgressAdmin(); updateModeButtons();
            showToast(`ã€Œ${modeNames[mode]}ã€å·²è¨­å®šç‚ºé€šé—œï¼`);
        }

        function resetProgress() { 
            if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é—–é—œé€²åº¦å—ï¼Ÿ")) { 
                progress = { reading: false, listening: false, spelling: false, unscramble: false, dictation: false, speaking: false }; 
                localStorage.setItem('gameProgress', JSON.stringify(progress)); 
                renderProgressAdmin(); updateModeButtons(); 
                alert("å…¨éƒ¨é€²åº¦å·²é‡ç½®"); 
            } 
        }
        
        function checkEmptyState() { 
            if (activeWords.length === 0) { 
                currentWord = null; 
                stopAllGames(); 
                document.getElementById('gameContent').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            } else {
                document.getElementById('emptyState').style.display = 'none';
            }
        }
        
        function updateModeButtons() { 
            let completedCount = 0; 
            basicModeOrder.forEach(m => { 
                const btn = document.getElementById(`modeBtn_${m}`); 
                if (progress[m]) { 
                    btn.classList.add('completed'); 
                    completedCount++; 
                } else { 
                    btn.classList.remove('completed'); 
                } 
            }); 
            
            const bonusModes = ['falling', 'whack', 'conveyor', 'match']; 
            const isUnlocked = completedCount === 6; 
            
            bonusModes.forEach(m => { 
                const btn = document.getElementById(`modeBtn_${m}`); 
                if (isUnlocked) { 
                    btn.classList.remove('locked'); 
                    btn.classList.add('unlocked-game'); 
                } else { 
                    btn.classList.add('locked'); 
                    btn.classList.remove('unlocked-game'); 
                } 
            }); 
        }

        function markModeComplete(mode) { 
            if (!progress[mode]) { 
                progress[mode] = true; 
                localStorage.setItem('gameProgress', JSON.stringify(progress)); 
                updateModeButtons(); 
                renderProgressAdmin(); 
                if (basicModeOrder.every(m => progress[m])) { 
                    playSFX('win'); 
                    showToast("ğŸ‰ æ­å–œï¼å·²è§£é–æ‰€æœ‰äº’å‹•éŠæˆ²ï¼"); 
                } 
            } 
        }
        
        function switchView(viewName) { 
            document.getElementById('adminSection').style.display = viewName === 'admin' ? 'block' : 'none'; 
            document.getElementById('gameSection').style.display = viewName === 'game' ? 'block' : 'none'; 
            stopAllGames(); 
            if (viewName === 'game') { 
                document.getElementById('adminTriggerBtn').style.display = 'block';
                if (audioCtx.state === 'suspended') audioCtx.resume(); 
                updateActiveWords(); 
                if (activeWords.length === 0) { checkEmptyState(); return; } 
                if (currentWord === null || !activeWords.some(w=>w.text===currentWord.text)) nextQuestion(); 
            } else {
                document.getElementById('adminTriggerBtn').style.display = 'none';
            }
        }

        function setGameMode(mode) { 
            stopAllGames(); 
            updateActiveWords();
            if (activeWords.length === 0) { switchView('game'); return; } 
            
            const bonusModes = ['falling', 'whack', 'conveyor', 'match']; 
            if (bonusModes.includes(mode)) { 
                const unlocked = basicModeOrder.every(m => progress[m]); 
                if (!unlocked) { showToast("ğŸ”’ è«‹å…ˆå®Œæˆæ‰€æœ‰åŸºç¤é¡Œå‹ä»¥è§£é–ï¼"); return; } 
            } 
            
            currentMode = mode; 
            if (audioCtx.state === 'suspended') audioCtx.resume(); 
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active')); 
            document.getElementById(`modeBtn_${mode}`).classList.add('active'); 
            document.getElementById('gameTitle').textContent = modeNames[mode] || (mode === 'falling' ? 'ğŸŒ  æµæ˜Ÿé›¨' : mode === 'whack' ? 'ğŸ”¨ æ‰“åœ°é¼ ' : (mode === 'conveyor' ? 'ğŸ­ è¼¸é€å¸¶' : 'ğŸ§© åœ–ç‰‡é…å°')); 
            ['fallingGameArea','whackGameArea','conveyorGameArea','matchGameArea','staticGameArea','progressDisplay','stageClearMsg'].forEach(id => document.getElementById(id).style.display='none'); 
            
            if (bonusModes.includes(mode)) { 
                document.getElementById(`${mode}GameArea`).style.display = 'flex'; 
                if(mode !== 'match') document.getElementById(`${mode}GameArea`).style.display = 'block';

                document.getElementById(`${mode}Overlay`).style.display = 'flex'; 
                document.getElementById(`${mode}Score`).textContent = '0'; 
                document.getElementById(`${mode}Hearts`).textContent = 'â¤ï¸â¤ï¸â¤ï¸'; 
                document.querySelector(`#${mode}Overlay button`).onclick = () => startMinigame(mode); 
            } else { 
                document.getElementById('staticGameArea').style.display = 'block'; 
                document.getElementById('progressDisplay').style.display = 'block'; 
                resetGameQueue(false); 
                nextQuestion(); 
            } 
        }

        function nextQuestion() { 
            if (['falling','whack','conveyor','match'].includes(currentMode)) return; 
            if (activeWords.length === 0) { switchView('game'); return; } 
            
            document.getElementById('gameContent').style.display='block'; 
            document.getElementById('emptyState').style.display='none'; 
            document.getElementById('feedbackMsg').textContent = ''; 
            document.getElementById('nextBtn').style.display = 'none'; 
            
            if (gameQueue.length === 0) { 
                markModeComplete(currentMode); 
                document.getElementById('staticGameArea').style.display = 'none'; 
                document.getElementById('stageClearMsg').style.display = 'block'; 
                document.getElementById('progressDisplay').textContent = "å®Œæˆï¼"; 
                return; 
            } 
            
            currentWord = gameQueue.pop(); 
            assignVoiceForCurrentQuestion(); 
            updateProgress(); 
            loadUIForCurrentMode(); 
        }

        // --- æ™ºæ…§è·³è½‰ (å¼·åŠ›ä¿®æ­£ç‰ˆ) ---
        function continueToNextMode() { 
            // å°‹æ‰¾ç¬¬ä¸€å€‹æœªå®Œæˆçš„åŸºç¤é—œå¡
            const firstIncomplete = basicModeOrder.find(m => !progress[m]);
            
            if (firstIncomplete) {
                setGameMode(firstIncomplete);
            } else {
                // å¦‚æœå…¨éƒ¨éƒ½å·²å®Œæˆ (å…¨éƒ¨ç‚º true)ï¼Œå‰‡å¼•å°è‡³æµæ˜Ÿé›¨
                setGameMode('falling');
            }
        }

        function restartCurrentMode() { document.getElementById('stageClearMsg').style.display = 'none'; document.getElementById('staticGameArea').style.display = 'block'; resetGameQueue(true); nextQuestion(); }
        function resetGameQueue(notify) { gameQueue = [...activeWords].sort(()=>Math.random()-0.5); if(notify) showToast("æ–°ä¸€è¼ªé–‹å§‹ï¼"); updateProgress(); }
        function updateProgress() { const t = activeWords.length; const c = t - gameQueue.length; document.getElementById('progressDisplay').textContent = t>0 ? `é€²åº¦ï¼š${c||1} / ${t}` : ''; }
        function stopAllGames() { 
            isGameRunning=false; 
            if(miniGameInterval)clearInterval(miniGameInterval); 
            if(miniGameLoop)cancelAnimationFrame(miniGameLoop); 
            document.getElementById('fallingItemsContainer').innerHTML=''; 
            document.getElementById('conveyorItems').innerHTML=''; 
            activeItems=[]; 
        }
        
        function startMinigame(m) { 
            if(activeWords.length===0)return; 
            isGameRunning=true; lives=3; score=0; itemsSinceLastTarget=0; 
            document.getElementById(`${m}Overlay`).style.display='none'; 
            document.getElementById(`${m}Score`).textContent=score; 
            document.getElementById(`${m}Hearts`).textContent='â¤ï¸â¤ï¸â¤ï¸'; 
            if(m==='falling')startFallingRound(); 
            else if(m==='whack')startWhackRound(); 
            else if(m==='conveyor')startConveyorRound();
            else if(m==='match')startMatchRound();
        }

        function handleGameLifeLoss(m,msg){ 
            playSFX('wrong'); lives--; 
            document.getElementById(`${m}Hearts`).textContent='â¤ï¸'.repeat(lives); 
            showToast(`ğŸ’” ${msg}`); 
            if(lives<=0){ 
                stopAllGames(); 
                document.getElementById(`${m}Overlay`).style.display='flex'; 
                document.querySelector(`#${m}Overlay h3`).textContent="éŠæˆ²çµæŸ"; 
                document.querySelector(`#${m}Overlay p`).textContent=`æœ€çµ‚åˆ†æ•¸: ${score}`; 
                document.querySelector(`#${m}Overlay button`).textContent="å†ç©ä¸€æ¬¡"; 
            } 
        }
        function handleGameScore(m,p){ playSFX('correct'); score+=p; document.getElementById(`${m}Score`).textContent=score; }
        
        // --- æ—¢æœ‰éŠæˆ²é‚è¼¯çœç•¥ï¼Œä¿æŒåŸæ¨£ ---
        function startFallingRound() { if(!isGameRunning)return; if(miniGameLoop)cancelAnimationFrame(miniGameLoop); setupRoundWord(); let maxC = Math.min(6, activeWords.length); if(maxC<3)maxC=3; let count = Math.floor(Math.random()*(maxC-3+1))+3; let o=getOptions(currentWord, count-1); const c=document.getElementById('fallingItemsContainer'); c.innerHTML=''; activeItems=[]; let lc=0; const colW=100/count; const speedMultiplier = 1 + (fallingSpeedLevel - 1) * 0.5; o.forEach((wObj,i)=>{ const el=document.createElement('div'); el.className='falling-item'; let leftPos = (i*colW) + (Math.random()*(colW-20)); el.style.left=leftPos+'%'; el.dataset.word=wObj.text; el.onclick=()=>{ if(el.classList.contains('processed'))return; el.classList.add('processed'); if(wObj.text===currentWord.text){ el.style.background='#2ecc71'; el.style.opacity=0; el.style.transform='scale(1.2)'; handleGameScore('falling',10); if(miniGameLoop)cancelAnimationFrame(miniGameLoop); setTimeout(startFallingRound,800); } else { el.classList.add('shake-hard'); handleGameLifeLoss('falling',"é»éŒ¯äº†ï¼"); } }; const img=document.createElement('img'); img.src=getBingImg(wObj); img.onload=()=>{ lc++; if(lc===o.length)fallingLoop(); }; el.appendChild(img); c.appendChild(el); activeItems.push({el:el, top:-150-(Math.random()*100), speed:(0.8+Math.random()*0.5) * speedMultiplier}); }); }
        function fallingLoop(){ if(!isGameRunning)return; let a=0; activeItems.forEach(i=>{ if(i.el.classList.contains('processed'))return; a++; i.top+=i.speed; i.el.style.top=i.top+'px'; if(i.top>400){ i.el.classList.add('processed'); if(i.el.dataset.word===currentWord.text){ handleGameLifeLoss('falling',"æ¼æ¥äº†ï¼"); if(miniGameLoop)cancelAnimationFrame(miniGameLoop); setTimeout(startFallingRound,1000); } } }); if(a>0 && isGameRunning) miniGameLoop=requestAnimationFrame(fallingLoop); else if(isGameRunning) setTimeout(startFallingRound,500); }
        function startWhackRound(){ if(!isGameRunning)return; setupRoundWord(); if(miniGameInterval)clearInterval(miniGameInterval); miniGameInterval=setInterval(()=>{ if(!isGameRunning)return; const hs=document.querySelectorAll('.mole-hole'); const h=hs[Math.floor(Math.random()*hs.length)].querySelector('.mole'); if(h.classList.contains('up'))return; let sObj; const d=activeWords.filter(w=>w.text!==currentWord.text); if(d.length===0)sObj=currentWord; else { const isT=Math.random()<0.4; sObj=isT?currentWord:d[Math.floor(Math.random()*d.length)]; } h.innerHTML=`<img src="${getBingImg(sObj)}">`; h.classList.add('up'); h.classList.remove('hit-correct','hit-wrong'); h.onclick=()=>{ h.onclick=null; if(sObj.text===currentWord.text){ h.classList.add('hit-correct'); handleGameScore('whack',10); clearInterval(miniGameInterval); setTimeout(()=>{ h.classList.remove('up','hit-correct'); startWhackRound(); },500); } else { h.classList.add('hit-wrong'); handleGameLifeLoss('whack',"æ‰“éŒ¯äº†ï¼"); } }; setTimeout(()=>{ if(h.classList.contains('up')&&!h.classList.contains('hit-correct')) h.classList.remove('up','hit-wrong'); },1200); },1500); }
        function startConveyorRound(){ if(!isGameRunning)return; if(miniGameLoop)cancelAnimationFrame(miniGameLoop); setupRoundWord(); itemsSinceLastTarget=0; const c=document.getElementById('conveyorItems'); c.innerHTML=''; activeItems=[]; document.getElementById('conveyorGrabBtn').onclick=handleConveyorGrab; let f=0; const currentConveyorSpeed = 2.5 * (1 + (conveyorSpeedLevel - 1) * 0.5); function loop(){ if(!isGameRunning)return; activeItems.forEach((it,i)=>{ it.x-=currentConveyorSpeed; it.el.style.left=it.x+'px'; if(it.x<-100){ it.el.remove(); activeItems.splice(i,1); if(it.word===currentWord.text){ handleGameLifeLoss('conveyor',"æ¼æ‰äº†ï¼"); if(miniGameLoop)cancelAnimationFrame(miniGameLoop); setTimeout(startConveyorRound,1000); } } }); if(f%Math.max(60, 100 - Math.floor((conveyorSpeedLevel-1)*10)) ===0){ itemsSinceLastTarget++; let isT=Math.random()<0.3; if(itemsSinceLastTarget>=6)isT=true; if(isT)itemsSinceLastTarget=0; let wObj; const d=activeWords.filter(wd=>wd.text!==currentWord.text); if(d.length===0)wObj=currentWord; else wObj=isT?currentWord:d[Math.floor(Math.random()*d.length)]; const el=document.createElement('div'); el.className='conveyor-item'; el.innerHTML=`<img src="${getBingImg(wObj)}">`; el.style.left='600px'; c.appendChild(el); activeItems.push({el:el, x:600, word:wObj.text}); } f++; miniGameLoop=requestAnimationFrame(loop); } loop(); }
        function handleConveyorGrab(){ if(!isGameRunning)return; const z=document.querySelector('.conveyor-zone').getBoundingClientRect(); let g=false; for(let i=0;i<activeItems.length;i++){ const it=activeItems[i]; const r=it.el.getBoundingClientRect(); const c=r.left+r.width/2; if(c>z.left && c<z.right){ g=true; if(it.word===currentWord.text){ handleGameScore('conveyor',10); showToast("ğŸ‘Œ æŠ“åˆ°äº†ï¼"); it.el.style.background='#2ecc71'; it.el.style.transform='scale(0.1)'; it.el.style.transition='0.5s'; if(miniGameLoop)cancelAnimationFrame(miniGameLoop); setTimeout(startConveyorRound,1000); return; } else { it.el.style.background='#e74c3c'; it.el.style.animation='shakeHard 0.5s'; handleGameLifeLoss('conveyor',"æŠ“éŒ¯äº†ï¼"); } } } if(!g){ playSFX('wrong'); showToast("â“ æŠ“ç©ºäº†"); } }

        // --- æ–°å¢ï¼šé…å°éŠæˆ²é‚è¼¯ ---
        function startMatchRound() {
            if(!isGameRunning) return;
            const topRow = document.getElementById('matchTopRow');
            const bottomRow = document.getElementById('matchBottomRow');
            const centerZone = document.getElementById('matchCenterZone');
            
            topRow.innerHTML = ''; bottomRow.innerHTML = ''; centerZone.innerHTML = '';
            matchSelectedWord = null;

            let roundWords = [];
            let pool = [...activeWords];
            while(roundWords.length < 6) {
                if(pool.length === 0) pool = [...activeWords];
                const rndIndex = Math.floor(Math.random() * pool.length);
                roundWords.push(pool[rndIndex]);
                pool.splice(rndIndex, 1);
            }

            roundWords.forEach((wObj, index) => {
                const target = document.createElement('div');
                target.className = 'match-target';
                target.dataset.word = wObj.text;
                target.innerHTML = `<img src="${getBingImg(wObj)}">`;
                
                target.onmouseenter = () => {
                    if(!target.classList.contains('matched')) {
                        target.classList.add('hover-play');
                        currentWord = wObj; 
                        playCurrentAudio();
                    }
                };
                target.onmouseleave = () => target.classList.remove('hover-play');

                target.ondragover = (e) => e.preventDefault();
                target.ondrop = (e) => {
                    e.preventDefault();
                    const draggedText = e.dataTransfer.getData("text");
                    checkMatch(draggedText, target);
                };
                target.onclick = () => {
                    if(matchSelectedWord) {
                        checkMatch(matchSelectedWord.dataset.word, target);
                    }
                };

                if(index < 3) topRow.appendChild(target);
                else bottomRow.appendChild(target);
            });

            const shuffledWords = [...roundWords].sort(()=>Math.random()-0.5);
            shuffledWords.forEach(wObj => {
                const card = document.createElement('div');
                card.className = 'match-card';
                card.textContent = wObj.text;
                card.dataset.word = wObj.text;
                card.draggable = true;

                const rot = Math.floor(Math.random() * 40) - 20; 
                const top = Math.floor(Math.random() * 60) + 10; 
                const left = Math.floor(Math.random() * 80) + 5; 
                
                card.style.transform = `rotate(${rot}deg)`;
                card.style.top = top + '%';
                card.style.left = left + '%';

                card.ondragstart = (e) => {
                    e.dataTransfer.setData("text", wObj.text);
                    selectMatchCard(card);
                };

                card.onclick = (e) => {
                    e.stopPropagation();
                    selectMatchCard(card);
                };

                centerZone.appendChild(card);
            });
        }

        function selectMatchCard(card) {
            if(matchSelectedWord) matchSelectedWord.classList.remove('selected');
            matchSelectedWord = card;
            card.classList.add('selected');
            playSFX('pop');
        }

        function checkMatch(wordText, targetElem) {
            if(!matchSelectedWord) return;
            if(targetElem.classList.contains('matched')) return;

            if(wordText === targetElem.dataset.word) {
                playSFX('correct');
                handleGameScore('match', 10);
                targetElem.classList.add('matched');

                matchSelectedWord.style.top = '';
                matchSelectedWord.style.left = '';
                matchSelectedWord.style.transform = '';
                matchSelectedWord.className = 'match-card docked-card'; 
                matchSelectedWord.draggable = false; 
                matchSelectedWord.onclick = null; 

                targetElem.appendChild(matchSelectedWord); 

                matchSelectedWord = null;
                
                const remaining = document.querySelectorAll('.match-target:not(.matched)').length;
                if(remaining === 0) {
                    showToast("ğŸŒŸ å…¨æ•¸é…å°å®Œæˆï¼");
                    setTimeout(startMatchRound, 1500);
                }
            } else {
                playSFX('wrong');
                handleGameLifeLoss('match', 'é…å°éŒ¯èª¤ï¼');
                matchSelectedWord.classList.remove('selected');
                matchSelectedWord = null;
            }
        }


        function loadUIForCurrentMode(){ const m=currentMode; document.getElementById('commonImageArea').style.display=(m==='listening')?'none':'block'; document.getElementById('commonAudioBtn').style.display=(m==='listening'||m==='dictation'||m==='speaking')?'block':'none'; document.getElementById('inputTypeArea').style.display=(['spelling','unscramble','dictation'].includes(m))?'block':'none'; document.getElementById('choiceTypeArea').style.display=(['listening','reading'].includes(m))?'block':'none'; document.getElementById('speakingArea').style.display=(m==='speaking')?'block':'none'; document.getElementById('questionImage').className=(m==='dictation')?'game-image blurred-image':'game-image'; document.getElementById('submitBtn').style.display='inline-block'; document.getElementById('scrambleHint').style.display=(m==='unscramble')?'flex':'none'; if(m!=='listening')loadImage(currentWord); if(m==='listening'||m==='dictation'||m==='speaking')setTimeout(()=>playCurrentAudio(),300); if(m==='spelling')createInputPuzzle(currentWord.text,'mask'); else if(m==='unscramble'){ createInputPuzzle(currentWord.text,'all'); showScrambleHint(currentWord.text); } else if(m==='dictation')createInputPuzzle(currentWord.text,'all'); else if(m==='listening')setupChoiceGame(currentWord,'image'); else if(m==='reading')setupChoiceGame(currentWord,'text'); if(m==='speaking')resetSpeakingUI(); }
        function resetSpeakingUI() { document.getElementById('micBtn').classList.remove('listening'); document.getElementById('speakingResult').textContent = 'é»æ“Šé–‹å§‹'; document.getElementById('speakingResult').style.color = '#555'; document.getElementById('submitBtn').style.display='none'; }
        function startListening() { if(!recognition) { alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜"); return; } const mic=document.getElementById('micBtn'); const res=document.getElementById('speakingResult'); res.textContent="è½å–ä¸­..."; mic.classList.add('listening'); recognition.start(); }
        function createInputPuzzle(t,type){ const c=document.getElementById('wordPuzzle'); c.innerHTML=''; let m=[]; if(type==='mask'){ let idx=t.split('').map((_,i)=>i).sort(()=>Math.random()-0.5); m=idx.slice(0, Math.max(1, Math.ceil(t.length/2))); } else m=t.split('').map((_,i)=>i); t.split('').forEach((char,i)=>{ const b=document.createElement('div'); b.className='letter-box'; if(m.includes(i)){ const inp=document.createElement('input'); inp.className='missing-letter-input'; inp.maxLength=1; inp.dataset.answer=char; inp.oninput=(e)=>{ if(!/^[a-zA-Z]$/.test(e.target.value))e.target.value=''; if(e.target.value.length===1){ const all=document.querySelectorAll('.missing-letter-input'); const k=Array.from(all).indexOf(e.target); if(k<all.length-1)all[k+1].focus(); }}; inp.onkeydown=(e)=>{ if(e.key==='Enter')checkInputAnswer(); if(e.key==='Backspace'&&e.target.value===''){ const all=document.querySelectorAll('.missing-letter-input'); const k=Array.from(all).indexOf(e.target); if(k>0)all[k-1].focus(); }}; b.appendChild(inp); } else { b.textContent=char; b.style.fontSize="32px"; } c.appendChild(b); }); setTimeout(()=>{const f=c.querySelector('input');if(f)f.focus()},100); }
        function checkInputAnswer(){ const all=document.querySelectorAll('.missing-letter-input'); let ok=true; all.forEach(i=>{ if(i.value.toLowerCase()===i.dataset.answer)i.classList.add('correct'); else{ ok=false; i.classList.add('corrected'); i.value=i.dataset.answer; } i.disabled=true; }); playSFX(ok?'correct':'wrong'); if(currentMode==='dictation'&&ok)document.getElementById('questionImage').classList.remove('blurred-image'); showFeedback(ok,currentWord.text); }
        function showScrambleHint(t){ const c=document.getElementById('scrambleHint'); c.innerHTML=''; t.split('').sort(()=>Math.random()-0.5).forEach(x=>{ c.innerHTML+=`<span class="scramble-tile">${x}</span>`; }); }
        function setupChoiceGame(tObj,type){ const g=document.getElementById('optionsGrid'); g.innerHTML=''; canClickChoice=true; let opts=getOptions(tObj,3); opts.forEach(wObj=>{ const d=document.createElement('div'); if(type==='image'){ d.className='image-option'; d.innerHTML=`<img src="${getBingImg(wObj)}">`; } else { d.className='text-option'; d.textContent=wObj.text; } d.onclick=()=>{ if(!canClickChoice)return; if(wObj.text===tObj.text){ d.classList.add('correct-answer'); playSFX('correct'); showFeedback(true,tObj.text); canClickChoice=false; } else { d.classList.add('wrong-answer'); playSFX('wrong'); document.getElementById('feedbackMsg').textContent='å†è©¦ä¸€æ¬¡'; if(currentMode==='listening')playCurrentAudio(); } }; g.appendChild(d); }); }
        function getOptions(t,n){ let o=[t]; let d=activeWords.filter(w=>w.text!==t.text); if(activeWords.length<=n+1)return activeWords.slice().sort(()=>Math.random()-0.5); while(o.length<n+1){ const w=d[Math.floor(Math.random()*d.length)]; if(!o.some(x=>x.text===w.text))o.push(w); } return o.sort(()=>Math.random()-0.5); }
        function showFeedback(ok,t){ const f=document.getElementById('feedbackMsg'); f.innerHTML=ok?`<span class="text-success">æ­£ç¢ºï¼${t}</span>`:`<span class="text-error">éŒ¯äº†ï¼Œæ˜¯ ${t}</span>`; document.getElementById('submitBtn').style.display='none'; document.getElementById('nextBtn').style.display='inline-block'; if(ok)document.getElementById('nextBtn').focus(); }
        function setupRoundWord(){ currentWord=activeWords[Math.floor(Math.random()*activeWords.length)]; assignVoiceForCurrentQuestion(); playCurrentAudio(); }
        function playSFX(t){ if(audioCtx.state==='suspended')audioCtx.resume(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); if(t==='correct'){ o.type='sine'; o.frequency.setValueAtTime(800,audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(1200,audioCtx.currentTime+0.1); g.gain.setValueAtTime(0.3,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.4); o.start(); o.stop(audioCtx.currentTime+0.4); } else if(t==='win'){ o.type='triangle'; o.frequency.setValueAtTime(400,audioCtx.currentTime); o.frequency.setValueAtTime(600,audioCtx.currentTime+0.2); o.frequency.setValueAtTime(1000,audioCtx.currentTime+0.4); g.gain.setValueAtTime(0.3,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+1); o.start(); o.stop(audioCtx.currentTime+1); } else if(t==='pop'){ o.type='sine'; o.frequency.setValueAtTime(600,audioCtx.currentTime); g.gain.setValueAtTime(0.1,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1); o.start(); o.stop(audioCtx.currentTime+0.1); } else { o.type='sawtooth'; o.frequency.setValueAtTime(150,audioCtx.currentTime); g.gain.setValueAtTime(0.3,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.01,audioCtx.currentTime+0.3); o.start(); o.stop(audioCtx.currentTime+0.3); } }
        function showToast(m){ const t=document.getElementById('roundToast'); t.textContent=m; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',1000); }
        
        function loadImage(wObj){ const i=document.getElementById('questionImage'),l=document.getElementById('loadingText'); imageRequestId++; const id=imageRequestId; i.style.opacity='0'; l.style.display='block'; const s=getBingImg(wObj); const n=new Image(); n.src=s; n.onload=()=>{ if(id===imageRequestId){ i.src=s; i.style.opacity='1'; l.style.display='none'; }}; }
        function playCurrentAudio(){ if(!currentWord)return; window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(currentWord.text); u.rate=0.9; if(currentQuestionVoice)u.voice=currentQuestionVoice; window.speechSynthesis.speak(u); }
        function assignVoiceForCurrentQuestion(){ if(voices.length===0)voices=window.speechSynthesis.getVoices(); let c=voices.filter(v=>v.lang==='en-US'&&(v.name.includes('Google')||v.name.includes('Microsoft'))); if(c.length===0)c=voices.filter(v=>v.lang.startsWith('en')); currentQuestionVoice=c.length>0?c[Math.floor(Math.random()*c.length)]:null; }
    </script>
</body>
</html>
